{
 "accept_payment": 0,
 "allow_comments": 0,
 "allow_delete": 0,
 "allow_edit": 0,
 "allow_incomplete": 0,
 "allow_multiple": 0,
 "allow_print": 0,
 "amount": 0.0,
 "amount_based_on_field": 0,
 "client_script": "document.getElementsByClassName(\"btn-form-submit\")[0].innerText=\"Reservar Cita\"; \ndocument.getElementsByClassName(\"btn-form-submit\")[1].innerText=\"Reservar Cita\"; \nfrappe.web_form.on('appointment_date', (field, value) => {\n  // Check whether date is past \n  let sToday = moment(value,\"YY-MM-DD\") - moment(frappe.datetime.get_today(),\"YY-MM-DD\");\n  let appointment_date = new Date(value);\n  let appointment_type = $('input[data-fieldname=\"appointment_type\"]').val();\n  let department =  $('input[data-fieldname=\"department\"]').val();\n  let practitioner = $('input[data-fieldname=\"practitioner\"]').val();\n\n  if (sToday<0) {\n    frappe.msgprint({\n      title: __('Notificacion'),\n      indicator: 'red',\n      message: __('La fecha debe ser actual o futura y el Tipo de Cita, el Departamento y la Persona a Visitar son obligatorios')\n    });\n    frappe.web_form.set_value(\"appointment_date\", null);\n    return(false);\n  }\n  if (sToday >=0 && (!appointment_type || !department || !practitioner)) {\n    frappe.msgprint({\n      title: __('Notificacion'),\n      indicator: 'red',\n      message: __('El Tipo de Cita, el Departamento y la Persona a visitar son obligatorios')\n    });\n    frappe.web_form.set_value(\"appointment_date\", null);\n    return(false);\n  }\n  \nif (sToday >=0 && appointment_type && department && practitioner) {\n  const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };\n  // Modal Dialog searching available time slots for data\n  var d = new frappe.ui.Dialog({\n    title: __(\"Reservar hora de cita el \" + appointment_date.toLocaleDateString('es-ES', options) + '?'),\n    fields: [\n      { fieldtype: 'HTML', fieldname: 'available_slots'}\n    ],\n    primary_action_label: __(\"Fijar Seleccion\"),\n    primary_action: function() {\n      frappe.web_form.set_value('appointment_time', selected_slot);\n      d.hide();\n      d.get_primary_btn().attr('disabled', true);\n    },\n    secondary_action_label: __(\"Cerrar\"),\n    secondary_action: function() {\n      d.refresh();\n      //d.preventDefault();\n    }\n  });\n\n  d.set_values({\n    'available_slots': show_slots(d)\n  });\n\n  // disable dialog action initially\n  d.get_primary_btn().attr('disabled', true);\n  d.show();\n\n  function show_slots(d,fd) {\n    var fd = d.fields_dict;   \n    if (value && practitioner){\n      fd.available_slots.html(\"\");\n      frappe.call({\n        method: 'student_appointment.student_appointment.doctype.visitor_appointment.visitor_appointment.get_availability_data',\n        args: {\n\t  practitioner: practitioner,\n\t  date: value\n        },\n        callback: (r) => {\n          var data = r.message;\n\t  if(data.slot_details.length > 0) {\n\t    var $wrapper = d.fields_dict.available_slots.$wrapper;\n  \t    // make buttons for each slot\n\t    var slot_details = data.slot_details;\n\t    var slot_html = \"\";\n\t    for (let i = 0; i < slot_details.length; i++) {\n\t      slot_html = slot_html + `<label>${slot_details[i].slot_name}</label>`;\n\t      slot_html = slot_html + `<br/>` + slot_details[i].available_slots.map(slot => {\n\t        let disabled = '';\n\t        let start_str = slot.from_time;\n\t        let slot_start_time = moment(slot.from_time, 'HH:mm:ss');\n\t        let slot_to_time = moment(slot.to_time, 'HH:mm:ss');\n\t        let interval = (slot_to_time - slot_start_time)/60000 | 0;\n\t        // iterate in all booked appointments, update the start time and duration\n\t        slot_details[i].appointments.forEach(function(booked) {\n\t\t  let booked_moment = moment(booked.appointment_time, 'HH:mm:ss');\n\t\t  let end_time = booked_moment.clone().add(booked.duration, 'minutes');\n\t\t  // Deal with 0 duration appointments\n\t\t  if(booked_moment.isSame(slot_start_time) || booked_moment.isBetween(slot_start_time, slot_to_time)){\n\t\t    if(booked.duration == 0){\n\t\t      disabled = 'disabled=\"disabled\"';\n\t\t      return false;\n\t\t    }\n\t\t  }\n\t\t  // Check for overlaps considering appointment duration\n\t\t  if(slot_start_time.isBefore(end_time) && slot_to_time.isAfter(booked_moment)){\n\t\t    // There is an overlap\n\t\t    disabled = 'disabled=\"disabled\"';\n  \t\t    return false;\n\t\t  }\n\t        });\n\t        return `<button class=\"btn btn-default\"\n\t\t  data-name=${start_str}\n\t\t  data-duration=${interval}\n\t\t  style=\"margin: 0 10px 10px 0; width: 72px;\" ${disabled}>\n\t\t  ${start_str.substring(0, start_str.length - 3)}\n\t        </button>`;\n\t      }).join(\"\");\n\t      slot_html = slot_html + `<br/>`;\n\t    }\n  \t    $wrapper\n\t    .css('margin-bottom', 0)\n\t    .addClass('text-center')\n\t    .html(slot_html);\n  \t    // blue button when clicked\n\t    $wrapper.on('click', 'button', function() {\n\t      var $btn = $(this);\n\t      $wrapper.find('button').removeClass('btn-primary');\n\t      $btn.addClass('btn-primary');\n\t      selected_slot = $btn.attr('data-name');\n\t      duration = $btn.attr('data-duration');\n  \t      // enable dialog action\n\t      d.get_primary_btn().attr('disabled', null);\n\t    });\n  \t  }else {\n\t    fd.available_slots.html(\"Elige una fecha valida\".bold())\n\t  }\n        },\n        freeze: true,\n        freeze_message: __(\"Fetching records......\") \n      });\n    }else{\n      fd.available_slots.html(\"El Departamento, la Persona a Visitar y la Fecha son obligatorios\".bold());\n    }\n  }\n}\n});\n// Check appointment-type to set duration\nfrappe.web_form.on('appointment_type', (field, value) => {\n  let appointment_type = value // $('input[data-fieldname=\"appointment_type\"]').val();\n  frappe.web_form.set_value('department', null);\n  frappe.web_form.set_value('practitioner', null);\n  frappe.call({\n    method: 'student_appointment.student_appointment.doctype.visitor_appointment.visitor_appointment.get_duration',\n    args: {\n      appointment_type: appointment_type\n    }, \n    callback: (r) => {\n      var data = r.message;\n      frappe.web_form.set_value(\"duration\",data);; \n    }\n  });\n});\n// Check email validity\nfrappe.web_form.on('visitor', (field, value) => {\n  let visitor = value //$('input[data-fieldname=\"appointment_type\"]').val();\n  if (!validate_email(visitor)) {\n    frappe.msgprint({\n      title: __('Notificacion'),\n      indicator: 'red',\n      message: __(\"No has introducido un correo valido\")\n    });\n    frappe.web_form.set_value(\"visitor\",null);\n  }\n});\n// Check if department filled before select practitioner\nfrappe.web_form.on('practitioner', (field, value) => {\n  let department = $('input[data-fieldname=\"department\"]').val();\n  let appointment_type = $('input[data-fieldname=\"appointment_type\"]').val();\n  if (!department || !appointment_type) {\n    frappe.msgprint({\n      title: __('Notificacion'),\n      indicator: 'red',\n      message: __(\"Primero debes elegir el Tipo de Cita y el Departamento\")\n    });\n    frappe.web_form.set_value(\"practitioner\",null);\n    return(false);\n  }\n});\n// Fill department based on appointment_type\nfrappe.web_form.on('appointment_type', (field, value) => {\n  filterDepartment(value);\n});\nfunction filterDepartment(value) {\n$.ajax({\n  url: 'api/resource/Appointment Type?fields=[\"*\"]&filters=[[\"Appointment Type\",\"name\",\"=\",\"' + value + '\"]]',\n  success: function(result) {\n        var options = [];\n        for (var i = 0; i < result.data.length; i++) {\n          options.push({\n            'label': result.data[i].department,\n            'value': result.data[i].department\n          });\n        console.log(result.data[i].department);\n        };\n        \n        var field = frappe.web_form.get_field('department');\n        field._data = options;\n        field.refresh();\n      }\n    });\n};\n\n// Fill practitioner based on department\nfrappe.web_form.on('department', (field, value) => {\n  let appointment_type = $('input[data-fieldname=\"appointment_type\"]').val();\n  if ( !appointment_type ) {\n    frappe.msgprint({\n     title: __('Notificacion'),\n      indicator: 'red',\n      message: __(\"Se debe elegir primero el tipo de Cita\")\n    });\n    frappe.web_form.set_value(\"department\", null);\n    return(false);\n  }\n  filterPractitioner(value);\n});\nfunction filterPractitioner(value) {\n    $.ajax({\n      url: 'api/resource/School Practitioner?filters=[[\"School Practitioner\",\"department\",\"=\",\"' + value + '\"]]',\n      success: function(result) {\n        var options = [];\n        for (var i = 0; i < result.data.length; i++) {\n          options.push({\n            'label': result.data[i].name,\n            'value': result.data[i].name\n          });\n        };\n        \n        var field = frappe.web_form.get_field('practitioner');\n        field._data = options;\n        field.refresh();\n      }\n    });  \n  };",
 "creation": "2020-08-17 21:15:45.295430",
 "currency": "EUR",
 "doc_type": "Visitor Appointment",
 "docstatus": 0,
 "doctype": "Web Form",
 "idx": 0,
 "introduction_text": "<!-- ======= Header ======= -->\n<header class=\"fixed-top\" id=\"header\">\n  <div class=\"container-fluid\">\n    <div class=\"row justify-content-center\">\n      <div class=\"col-xl-10 d-flex align-items-center\">\n        <!-- <h1 class=\"logo mr-auto\"><a href=\"index.html\">Presento<span>.</span></a></h1> -->\n        <!-- Uncomment below if you prefer to use an image logo -->\n        <a class=\"logo mr-auto\" href=\"school_en\"><img alt=\"\" src=\"assets/Presento/assets/img/logo.png\"></a>\n        <nav class=\"nav-menu d-none d-lg-block\">\n          <ul>\n            <li><a href=\"school_es#about\">Nosotros</a></li>\n            <li><a href=\"school_es#services\">Servicios</a></li>\n            <li><a href=\"school_es#portfolio\">Portfolio</a></li>\n            <li><a href=\"school_es#team\">Equipo</a></li>\n            <li><a href=\"school_es#contact\">Contacto</a></li>\n            <li><a href=\"student-appointment_es\">Cita Previa</a></li>\n            <li class=\"drop-down\"><a>Idiomas</a>\n              <ul>\n                <li><a href=\"school_es\">Espa\u00f1ol</a></li>\n                <li><a href=\"school_en\">English</a></li>\n              </ul>\n            </li>\n            <li><a href=\"login\">Privado</a></li>\n          </ul>\n        </nav><!-- .nav-menu -->\n      </div>\n    </div>\n  </div>\n</header><!-- End Header -->\n<div class=\"section-title\">\n  <h3>Reserva tu cita con tu elecci\u00f3n y no la nuestra</h3>\n</div> \n\n",
 "is_standard": 1,
 "login_required": 0,
 "max_attachment_size": 0,
 "modified": "2020-08-17 21:53:28.893101",
 "modified_by": "Administrator",
 "module": "Student Appointment",
 "name": "cita-previa",
 "owner": "Administrator",
 "payment_button_label": "Buy Now",
 "published": 1,
 "route": "student-appointment_es",
 "show_in_grid": 0,
 "show_sidebar": 0,
 "sidebar_items": [],
 "success_message": "You have successfully made your appointment. You will receive soon a confirmation message on your email inbox.",
 "success_url": "/cita-previa",
 "title": "Cita Previa",
 "web_form_fields": [
  {
   "allow_read_on_all_link_options": 0,
   "fieldname": "section_break_0",
   "fieldtype": "Section Break",
   "hidden": 0,
   "label": "Detalles de la Reserva",
   "max_length": 0,
   "max_value": 0,
   "read_only": 0,
   "reqd": 0,
   "show_in_filter": 0
  },
  {
   "allow_read_on_all_link_options": 0,
   "default": "",
   "fieldname": "appointment_type",
   "fieldtype": "Link",
   "hidden": 0,
   "label": "Tipo de Cita",
   "max_length": 0,
   "max_value": 0,
   "options": "Appointment Type",
   "read_only": 0,
   "reqd": 1,
   "show_in_filter": 0
  },
  {
   "allow_read_on_all_link_options": 0,
   "default": "15",
   "description": "En Minutos",
   "fieldname": "duration",
   "fieldtype": "Int",
   "hidden": 0,
   "label": "Duracion",
   "max_length": 0,
   "max_value": 0,
   "read_only": 0,
   "reqd": 0,
   "show_in_filter": 0
  },
  {
   "allow_read_on_all_link_options": 0,
   "fieldname": "column_break_2",
   "fieldtype": "Column Break",
   "hidden": 0,
   "max_length": 0,
   "max_value": 0,
   "read_only": 0,
   "reqd": 0,
   "show_in_filter": 0
  },
  {
   "allow_read_on_all_link_options": 0,
   "default": "",
   "fieldname": "department",
   "fieldtype": "Link",
   "hidden": 0,
   "label": "Departamento",
   "max_length": 0,
   "max_value": 0,
   "options": "School Department",
   "read_only": 0,
   "reqd": 1,
   "show_in_filter": 0
  },
  {
   "allow_read_on_all_link_options": 0,
   "default": "",
   "fieldname": "practitioner",
   "fieldtype": "Link",
   "hidden": 0,
   "label": "Personal",
   "max_length": 0,
   "max_value": 0,
   "options": "School Practitioner",
   "read_only": 0,
   "reqd": 1,
   "show_in_filter": 0
  },
  {
   "allow_read_on_all_link_options": 0,
   "fieldname": "column_break_1",
   "fieldtype": "Column Break",
   "hidden": 0,
   "max_length": 0,
   "max_value": 0,
   "read_only": 0,
   "reqd": 0,
   "show_in_filter": 0
  },
  {
   "allow_read_on_all_link_options": 0,
   "fieldname": "appointment_date",
   "fieldtype": "Date",
   "hidden": 0,
   "label": "Dia de la Cita",
   "max_length": 0,
   "max_value": 0,
   "read_only": 0,
   "reqd": 1,
   "show_in_filter": 0
  },
  {
   "allow_read_on_all_link_options": 0,
   "depends_on": "appointment_date",
   "fieldname": "appointment_time",
   "fieldtype": "Time",
   "hidden": 0,
   "label": "Hora de la Cita",
   "max_length": 0,
   "max_value": 0,
   "read_only": 1,
   "reqd": 1,
   "show_in_filter": 0
  },
  {
   "allow_read_on_all_link_options": 0,
   "fieldname": "section_break_10",
   "fieldtype": "Section Break",
   "hidden": 0,
   "label": "Detalles Solicitante",
   "max_length": 0,
   "max_value": 0,
   "read_only": 0,
   "reqd": 0,
   "show_in_filter": 0
  },
  {
   "allow_read_on_all_link_options": 0,
   "description": "Introduce tu email como Identificador del Solicitante",
   "fieldname": "visitor",
   "fieldtype": "Data",
   "hidden": 0,
   "label": "Email Solicitante",
   "max_length": 0,
   "max_value": 0,
   "read_only": 0,
   "reqd": 1,
   "show_in_filter": 0
  },
  {
   "allow_read_on_all_link_options": 0,
   "fieldname": "visitor_name",
   "fieldtype": "Data",
   "hidden": 0,
   "label": "Nombre Solicitante",
   "max_length": 0,
   "max_value": 0,
   "read_only": 0,
   "reqd": 1,
   "show_in_filter": 0
  },
  {
   "allow_read_on_all_link_options": 0,
   "fieldname": "visitor_phone",
   "fieldtype": "Data",
   "hidden": 0,
   "label": "Telefono Contacto",
   "max_length": 0,
   "max_value": 0,
   "read_only": 0,
   "reqd": 1,
   "show_in_filter": 0
  },
  {
   "allow_read_on_all_link_options": 0,
   "default": "1",
   "description": "Si no quieres recibir recordatorio de tu cita, no olvides desactivar la seleccion.",
   "fieldname": "appointment_reminder",
   "fieldtype": "Check",
   "hidden": 0,
   "label": "Recordatorio Cita",
   "max_length": 0,
   "max_value": 0,
   "read_only": 0,
   "reqd": 0,
   "show_in_filter": 0
  },
  {
   "allow_read_on_all_link_options": 0,
   "fieldname": "column_break_14",
   "fieldtype": "Column Break",
   "hidden": 0,
   "max_length": 0,
   "max_value": 0,
   "read_only": 0,
   "reqd": 0,
   "show_in_filter": 0
  },
  {
   "allow_read_on_all_link_options": 0,
   "description": "En caso de representar a un estudiante, por favor introducta el Nombre completo en el cuadro de Observaciones.",
   "fieldname": "notes",
   "fieldtype": "Long Text",
   "hidden": 0,
   "label": "Observaciones",
   "max_length": 0,
   "max_value": 0,
   "read_only": 0,
   "reqd": 0,
   "show_in_filter": 0
  },
  {
   "allow_read_on_all_link_options": 0,
   "fieldname": "column_break_18",
   "fieldtype": "Column Break",
   "hidden": 0,
   "max_length": 0,
   "max_value": 0,
   "read_only": 0,
   "reqd": 0,
   "show_in_filter": 0
  }
 ]
}